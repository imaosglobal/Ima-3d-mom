<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>אמא / Mom</title>

<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- ThreeJS + main.js -->
<script type="module" src="./main.js"></script>

<style>
html,body{margin:0;padding:0;width:100%;height:100%;font-family:system-ui,Arial;background:#f4f5f7;overflow:hidden;}
#welcome{position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(180deg,#ffffff,#eef1f5); z-index:20; transition:opacity .6s;}
#welcome.hide{opacity:0; pointer-events:none;}
#welcome img{width:240px; border-radius:24px; box-shadow:0 20px 50px rgba(0,0,0,.15);}
#welcome h1{margin:16px 0 4px;}
#welcome p{margin:0 0 20px;color:#555;}
#welcome small{margin-top:14px;color:#666;}
#app,#viewer{position:absolute; inset:0;}
#viewer{display:none;}
#ui{position:absolute; inset:0; display:none; pointer-events:none; z-index:10;}
#speech{position:absolute; bottom:140px; right:30px; max-width:320px; background:white; padding:18px 22px; border-radius:22px; box-shadow:0 15px 40px rgba(0,0,0,.2); font-size:1rem; opacity:0; transition:.4s;}
#speech.show{opacity:1;}
#chat{position:absolute; bottom:30px; right:30px; display:flex; gap:10px; pointer-events:auto;}
#chat input{padding:14px 18px; border-radius:20px; border:none; width:220px; box-shadow:0 8px 20px rgba(0,0,0,.15);}
#chat button{border:none; border-radius:20px; padding:14px 18px; background:#000; color:white; cursor:pointer;}
#share{position:absolute; top:20px; left:20px; pointer-events:auto; background:white; padding:10px 14px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.15); font-size:.85rem; cursor:pointer;}
#logout{position:absolute; top:20px; right:20px; pointer-events:auto; background:white; padding:10px 14px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.15); font-size:.85rem; cursor:pointer; display:none;}
#crash{display:none; position:fixed; inset:0; background:#200; color:#ffdede; z-index:999; justify-content:center; align-items:center; text-align:center;}
#debug{position:absolute; top:80px; left:20px; background:rgba(0,0,0,0.5); color:white; padding:8px 12px; border-radius:10px; font-size:0.8rem; z-index:50; white-space:pre-line;}
</style>
</head>

<body>
<div id="crash"><div><h2>אמא מתייצבת…</h2><p>עוד רגע חוזרים</p></div></div>

<div id="welcome">
  <img src="server/public/mom.jpg" alt="אמא">
  <h1>אמא</h1>
  <p>מרחב אישי, רגשי וחי</p>

  <div id="g_id_onload"
       data-client_id="1093623573018-6s23clvor9u80r08135aelfatuib3a55.apps.googleusercontent.com"
       data-login_uri=""
       data-callback="onSignIn"
       data-auto_prompt="false"
       data-cancel_on_tap_outside="true"
       data-itp_support="true">
  </div>
  <div class="g_id_signin"></div>

  <small>אפשר להתחיל לדבר עם אמא</small>
</div>

<div id="app">
  <div id="viewer"></div>
  <div id="ui">
    <div id="speech"></div>
    <div id="chat">
      <input id="userInput" placeholder="אפשר לכתוב כאן…">
      <button onclick="send()">שליחה</button>
    </div>
    <div id="share" onclick="share()">לשתף את אמא</div>
    <div id="logout" onclick="signOut()">התנתק/י</div>
    <div id="debug">Loading...</div>
  </div>
</div>

<script type="module">
import { Mom3D } from './main.js';

let currentUser = null;
const welcomeEl = document.getElementById("welcome");
const viewerEl = document.getElementById("viewer");
const uiEl = document.getElementById("ui");
const logoutEl = document.getElementById("logout");
const debugEl = document.getElementById("debug");

/* ===== Helpers ===== */
function showApp() {
  welcomeEl.classList.add("hide");
  viewerEl.style.display = "block";
  uiEl.style.display = "block";
  logoutEl.style.display = "block";
  Mom3D.init();
  MomSay("אני כאן. אפשר להתחיל.");
  setTimeout(() => MomSay("מה שלומך עכשיו?"), 6000);
  updateDebug("showApp called");
}

function showWelcome() {
  welcomeEl.classList.remove("hide");
  viewerEl.style.display = "none";
  uiEl.style.display = "none";
  logoutEl.style.display = "none";
  if(google?.accounts?.id) google.accounts.id.prompt();
  updateDebug("showWelcome called");
}

function updateDebug(msg){
    if(debugEl){
        debugEl.textContent = 
            `Debug: ${msg}\nUser: ${currentUser ? currentUser.name : "לא מחובר"}\n` +
            `Model: ${Mom3D.mom ? "Loaded" : "Fallback"}\nEmotion: ${Mom3D.emotion}`;
    }
}

/* ===== MomSay / Chat ===== */
window.MomSay = function(text){
  const s = document.getElementById("speech");
  s.textContent = text;
  s.classList.add("show");
  setTimeout(()=>s.classList.remove("show"),7000);
}

window.send = function(){
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if(!text) return;
  input.value="";
  Mom3D.reactToEmotion(text);
  MomSay(reply(text));
  updateDebug("User sent message");
}

function reply(t){
  if(t.includes("קשה")) return "אני שומעת. אפשר לקחת רגע ביחד.";
  if(t.includes("טוב")) return "נעים לשמוע. אפשר להישאר עם זה.";
  return "אני איתך. אפשר להמשיך.";
}

/* ===== Share ===== */
window.share = function(){
  const url = location.origin+"?ref=mom";
  navigator.clipboard.writeText(url);
  MomSay("הקישור הועתק. אפשר לשתף כשמרגיש נכון.");
  updateDebug("Shared URL");
}

/* ===== Logout ===== */
window.signOut = async function(){
  await fetch('/logout', { method:'POST', credentials:'include' });
  currentUser = null;
  showWelcome();
  MomSay("התנתקת/י בהצלחה.");
  if(google?.accounts?.id) google.accounts.id.disableAutoSelect();
  updateDebug("Signed out");
}

/* ===== Google Sign-In Callback ===== */
window.onSignIn = async function(credentialResponse){
  try{
    const meResp = await fetch('/me',{credentials:'include'});
    const data = await meResp.json();
    if(data.loggedIn){
      currentUser = data.user;
      showApp();
    } else {
      showWelcome();
    }
  } catch(err){
    console.error("Sign-in check failed:",err);
    showWelcome();
  }
}

/* ===== Check session on load + fallback timeout ===== */
(async function init(){
  try{
    const fallback = setTimeout(()=>{ if(!currentUser) showWelcome(); },5000);
    const meResp = await fetch('/me',{credentials:'include'});
    const data = await meResp.json();
    clearTimeout(fallback);
    if(data.loggedIn){
      currentUser = data.user;
      showApp();
    } else {
      showWelcome();
    }
  } catch(err){
    console.error("Session check failed:",err);
    showWelcome();
  }
})();
</script>

</body>
</html>

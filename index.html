<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ima 3D — Debug Loader</title>
<style>
  html, body { margin:0; padding:0; width:100%; height:100%; background:#111; overflow:hidden; color:#eee; font-family:system-ui; }
  #scene-container { width:100%; height:100vh; }
  #overlay {
    position:absolute; top:12px; left:12px; right:12px; z-index:9999;
    background: rgba(0,0,0,0.45); padding:10px; border-radius:8px; max-height:40vh; overflow:auto;
  }
  #loader { color:#ddd; font-weight:600; }
  .error { color: #ff8b8b; margin-top:6px; font-size:0.95rem; }
  .info { color:#bfe7ff; margin-top:6px; font-size:0.9rem; }
  a { color:#9fdcff; word-break:break-all; }
</style>
</head>
<body>
<div id="scene-container"></div>

<div id="overlay">
  <div id="loader">טוען מודל אמא...</div>
  <div id="messages"></div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.154.0/examples/jsm/loaders/GLTFLoader.js';
import { DRACOLoader } from 'https://unpkg.com/three@0.154.0/examples/jsm/loaders/DRACOLoader.js';
import { OrbitControls } from 'https://unpkg.com/three@0.154.0/examples/jsm/controls/OrbitControls.js';

const overlayLoader = document.getElementById('loader');
const messages = document.getElementById('messages');
const container = document.getElementById('scene-container');

function logInfo(txt){ const d = document.createElement('div'); d.className='info'; d.textContent = txt; messages.appendChild(d); }
function logError(txt){ const d = document.createElement('div'); d.className='error'; d.textContent = txt; messages.appendChild(d); }

// סצנה בסיסית
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.shadowMap.enabled = true;
container.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0f0f12);

const camera = new THREE.PerspectiveCamera(50, container.clientWidth/container.clientHeight, 0.1, 1000);
camera.position.set(0,1.6,3);

const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
scene.add(hemi);

const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(5, 10, 7.5);
dir.castShadow = true;
scene.add(dir);

const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0,1.2,0);
controls.enableDamping = true;

// loaders
const loader = new GLTFLoader();
const dracoLoader = new DRACOLoader();
dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
loader.setDRACOLoader(dracoLoader);

// רשימת URL-ים עם cache-bust (מנסה מספר מקורות)
const ts = Date.now();
const modelCandidates = [
  `https://cdn.jsdelivr.net/gh/imaosglobal/Ima-3d-mom/assets/ima.glb?t=${ts}`,
  `https://raw.githubusercontent.com/imaosglobal/Ima-3d-mom/main/assets/ima.glb?t=${ts}`,
  // fallback אחר אם תרצה להוסיף
];

let tried = 0;

async function tryFetchURL(url){
  try{
    logInfo(`בודק URL: ${url}`);
    // ננסה לעשות fetch ראשון כדי לקבל סטטוס לפני GLTFLoader
    const resp = await fetch(url, { method:'GET', mode:'cors' });
    logInfo(`סטטוס: ${resp.status} ${resp.statusText}`);
    if(!resp.ok){
      logError(`קבלת שגיאה מהרשת: ${resp.status}`);
      return false;
    }
    // ננסה לקרוא חלק קטן -> blob header
    const blob = await resp.blob();
    logInfo(`קיבל blob בגודל: ${blob.size} bytes (type: ${blob.type || 'n/a'})`);
    // אם יש סיכוי שמדובר בקובץ תקין — החזר אמת
    return blob.size > 100; // סף מינימלי
  }catch(e){
    logError('שגיאת רשת בזמן fetch: ' + (e.message || e));
    return false;
  }
}

function loadWithThree(url){
  overlayLoader.textContent = 'טוען מודל…';
  loader.load(
    url,
    gltf => {
      overlayLoader.style.display = 'none';
      logInfo('טעינה בוצעה בהצלחה: ' + url);

      const root = gltf.scene || gltf.scenes[0];
      root.traverse(n => { if(n.isMesh){ n.castShadow=true; n.receiveShadow=true; } });
      scene.add(root);

      // normalize
      const box = new THREE.Box3().setFromObject(root);
      const center = box.getCenter(new THREE.Vector3());
      root.position.sub(center);
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      if(maxDim > 2) root.scale.multiplyScalar(2 / maxDim);
    },
    xhr => {
      if(xhr && xhr.lengthComputable){
        overlayLoader.textContent = `טוען... ${Math.floor(xhr.loaded/xhr.total * 100)}%`;
      }
    },
    err => {
      logError('Three GLTFLoader שגיאה: ' + (err?.message || JSON.stringify(err)));
      tried++;
      nextCandidate();
    }
  );
}

async function nextCandidate(){
  if(tried >= modelCandidates.length){
    overlayLoader.textContent = 'לא הצלחנו לטעון אף מודל אמא. בדוק את הקבצים ב־GitHub.';
    logError('נגמרו ה־candidates.');
    return;
  }
  const url = modelCandidates[tried];
  logInfo(`מנסה מועמד ${tried+1}/${modelCandidates.length}`);
  const ok = await tryFetchURL(url);
  if(ok){
    logInfo('הקובץ קיים — מפעיל GLTFLoader על: ' + url);
    loadWithThree(url);
  } else {
    logError('URL לא תקין/לא זמין: ' + url);
    tried++;
    nextCandidate();
  }
}

nextCandidate();

window.addEventListener('resize', ()=>{
  camera.aspect = container.clientWidth / container.clientHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(container.clientWidth, container.clientHeight);
});

function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>

<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>אמא / Mom</title>

<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- ThreeJS -->
<script type="module" src="./main.js"></script>

<style>
html,body{
  margin:0; padding:0; width:100%; height:100%;
  font-family:system-ui, Arial; background:linear-gradient(180deg,#eef2f7,#ffffff); overflow:hidden; color:#222;
}
#welcome{
  position:fixed; inset:0;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  background:linear-gradient(180deg,#f4f6f8,#eef2f7); z-index:20; transition:opacity .6s;
}
#welcome.hide{opacity:0; pointer-events:none;}
#welcome img{width:240px; border-radius:32px; box-shadow:0 20px 60px rgba(0,0,0,.12);}
#welcome h1{margin:16px 0 4px; font-size:2.2rem; letter-spacing:0.5px;}
#welcome p{margin:0 0 20px;color:#555; text-align:center; max-width:300px; line-height:1.4;}
#welcome small{margin-top:14px;color:#666; font-style:italic;}
#app,#viewer{position:absolute; inset:0;}
#viewer{display:none;}
#ui{position:absolute; inset:0; display:none; pointer-events:none; z-index:10;}
#speech{position:absolute; bottom:160px; right:30px; max-width:320px;
  background:rgba(255,255,255,0.9); padding:18px 22px; border-radius:24px;
  box-shadow:0 15px 40px rgba(0,0,0,.15); font-size:1rem; line-height:1.4; color:#222;
  opacity:0; transition:.5s;}
#speech.show{opacity:1;}
#chat{position:absolute; bottom:30px; right:30px; display:flex; gap:10px; pointer-events:auto;}
#chat input{padding:14px 18px; border-radius:24px; border:none; width:220px; box-shadow:0 8px 20px rgba(0,0,0,.12);}
#chat button{border:none; border-radius:24px; padding:14px 18px; background:#444; color:white; cursor:pointer; font-weight:500;}
#share{position:absolute; top:20px; left:20px; pointer-events:auto; background:white; padding:10px 14px; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.12); font-size:.85rem; cursor:pointer;}
#logout{position:absolute; top:20px; right:20px; pointer-events:auto; background:white; padding:10px 14px; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.12); font-size:.85rem; cursor:pointer; display:none;}
#crash{display:none; position:fixed; inset:0; background:#200; color:#ffdede; z-index:999; justify-content:center; align-items:center; text-align:center;}
</style>
</head>

<body>

<div id="crash">
  <div>
    <h2>אמא מתייצבת…</h2>
    <p>מתחברים מחדש…</p>
  </div>
</div>

<div id="welcome">
  <img src="server/public/mom.jpg" alt="אמא">
  <h1>אמא</h1>
  <p>מרחב רגשי, חי ונוכח. אפשר להיות כאן יחד, בלי למהר.</p>

  <div id="g_id_onload"
       data-client_id="1093623573018-6s23clvor9u80r08135aelfatuib3a55.apps.googleusercontent.com"
       data-login_uri=""
       data-callback="onSignIn"
       data-auto_prompt="false"
       data-cancel_on_tap_outside="true"
       data-itp_support="true">
  </div>
  <div class="g_id_signin"></div>

  <small>אפשר לדבר, להרגיש, או לשתוק ביחד</small>
</div>

<div id="app">
  <div id="viewer"></div>
  <div id="ui">
    <div id="speech"></div>
    <div id="chat">
      <input id="userInput" placeholder="אפשר לכתוב כאן או לשתוק…">
      <button onclick="send()">שליחה</button>
    </div>
    <div id="share" onclick="share()">לשתף את אמא כשמרגיש נכון</div>
    <div id="logout" onclick="signOut()">התנתק/י</div>
  </div>
</div>

<script type="module">
import { Mom3D } from './main.js';

let currentUser = null;
const welcomeEl = document.getElementById("welcome");
const viewerEl = document.getElementById("viewer");
const uiEl = document.getElementById("ui");
const logoutEl = document.getElementById("logout");
const speechEl = document.getElementById("speech");

/* ===== Helpers ===== */
function showApp() {
  welcomeEl.classList.add("hide");
  viewerEl.style.display = "block";
  uiEl.style.display = "block";
  logoutEl.style.display = "block";
  Mom3D.init();
  MomSay("אני כאן. אפשר להיות כאן יחד.");
  Mom3D.floatGently();
  setTimeout(()=>MomSay("מה מרגישים עכשיו?"),6000);
}

function showWelcome() {
  welcomeEl.classList.remove("hide");
  viewerEl.style.display = "none";
  uiEl.style.display = "none";
  logoutEl.style.display = "none";
  if(google?.accounts?.id) google.accounts.id.prompt();
}

/* ===== MomSay / Chat ===== */
window.MomSay = function(text){
  speechEl.textContent = text;
  speechEl.classList.add("show");
  setTimeout(()=>speechEl.classList.remove("show"),7000);
  Mom3D.reactToEmotion(text);
}

window.send = function(){
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if(!text) return;
  input.value="";
  MomSay(reply(text));
}

function reply(t){
  t = t.toLowerCase();
  if(t.includes("קשה") || t.includes("עצוב")) return "אני כאן. אפשר לקחת רגע יחד, בלי לחץ.";
  if(t.includes("טוב") || t.includes("נח")) return "נעים לשמוע. אפשר פשוט להיות עם זה.";
  if(t.includes("כועס") || t.includes("מוטרדת")) return "אני שומעת אותך. אפשר לשחרר יחד.";
  return "אני איתך. אפשר להרגיש, לשתוק או לדבר כאוות נפשך.";
}

/* ===== Share ===== */
window.share = function(){
  const url = location.origin+"?ref=mom";
  navigator.clipboard.writeText(url);
  MomSay("הקישור הועתק. אפשר לשתף כשמרגיש נכון.");
}

/* ===== Logout ===== */
window.signOut = async function(){
  await fetch('/logout', { method:'POST', credentials:'include' });
  currentUser = null;
  showWelcome();
  MomSay("התנתקת/י בהצלחה.");
  if(google?.accounts?.id) google.accounts.id.disableAutoSelect();
}

/* ===== Google Sign-In Callback ===== */
window.onSignIn = async function(credentialResponse){
  try{
    const meResp = await fetch('/me',{credentials:'include'});
    const data = await meResp.json();
    if(data.loggedIn){
      currentUser = data.user;
      showApp();
    } else {
      showWelcome();
    }
  } catch(err){
    console.error("Sign-in check failed:",err);
    showWelcome();
  }
}

/* ===== Session Check ===== */
(async function init(){
  try{
    const fallback = setTimeout(()=>{ if(!currentUser) showWelcome(); },5000);
    const meResp = await fetch('/me',{credentials:'include'});
    const data = await meResp.json();
    clearTimeout(fallback);
    if(data.loggedIn){
      currentUser = data.user;
      showApp();
    } else {
      showWelcome();
    }
  } catch(err){
    console.error("Session check failed:",err);
    showWelcome();
  }
})();
</script>

</body>
</html>
